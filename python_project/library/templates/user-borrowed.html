{% load static %}
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý mượn trả</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/user-borrowed.css' %}?v={{ timestamp }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  </head>

  <body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <div class="borrow-wrapper">

      <form class="search-panel" method="GET" action="">
        <input type="text" name="q" placeholder="Tìm người dùng hoặc sách..." value="{{ request.GET.q|default:'' }}" />
        <button type="submit"><i class="fas fa-search"></i> Tìm</button>
      </form>

      <div class="tabs">
        <button type="button" class="tab" data-tab="reserved">Sách đã đặt trước</button>
        <button type="button" class="tab" data-tab="return">Đã mượn</button>
        <button type="button" class="tab" data-tab="returned">Đã trả</button>
        <span class="has-rent">Đã mượn {{ current_borrowed_count }} / {{ limit }} cuốn sách</span>
      </div>

      <div class="tab-content" id="reserved">
        <div id="reserved-borrow-container"
             hx-get="{% url 'get_user_reserved_books' %}"
             hx-trigger="load, every 2s">
             <p style="text-align:center; padding: 20px;">Đang tải danh sách đặt trước...</p>
        </div>
      </div>

      <div class="tab-content" id="return">
        <div id="active-borrow-container"
             hx-get="{% url 'get_user_active_borrows' %}"
             hx-trigger="load, every 2s">
             <p style="text-align:center; padding: 20px;">Đang cập nhật dữ liệu...</p>
        </div>
      </div>

      <div class="tab-content" id="returned">
        <div id="returned-borrow-container"
             hx-get="{% url 'get_user_returned_history' %}"
             hx-trigger="load, every 2s">
            <p style="text-align:center; padding: 20px;">Đang tải lịch sử...</p>
        </div>
      </div>

    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.tab')
        const contents = document.querySelectorAll('.tab-content')

        function showTab(tabId) {
          tabs.forEach((t) => t.classList.remove('active'))
          contents.forEach((c) => (c.style.display = 'none'))

          const tabBtn = document.querySelector(`.tab[data-tab="${tabId}"]`)
          const content = document.getElementById(tabId)

          if (tabBtn) tabBtn.classList.add('active')
          if (content) content.style.display = 'block'
        }

        const params = new URLSearchParams(window.location.search)
        const tabParam = params.get('tab')

        if (tabParam === 'returned') {
            showTab('returned');
        } else if (tabParam === 'return') {
            showTab('return');
        } else {
            showTab('reserved');
        }

        tabs.forEach((tab) => {
          tab.addEventListener('click', () => showTab(tab.dataset.tab))
        })
      })
    </script>
  </body>
</html>