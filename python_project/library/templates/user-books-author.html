{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch s√°ch / Nh√† xu·∫•t b·∫£n</title>
    <link rel="stylesheet" href="{% static 'css/admin-book-author.css' %}?v={{ timestamp }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="book-page-container">

{% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
    
    <!-- TOP: SEARCH SECTION -->
    <div class="top-section">
        <h2 class="section-title">T√¨m ki·∫øm s√°ch</h2>
        <form method="get" class="search-row">
            <input type="text" name="keyword" class="search-input"
                   placeholder="Nh·∫≠p t√™n s√°ch, m√£ s√°ch, t·ª´ kho√°..." value="{{ keyword }}" />
            <button class="btn-search" type="submit">T√¨m ki·∫øm</button>
        </form>
    </div>

    <!-- MIDDLE: FILTER SECTION -->
    <form method="get" class="middle-section">
    <div class="filter-group">
      <label>Th·ªÉ lo·∫°i</label>
      <select name="category">
        <option value="">T·∫•t c·∫£</option>
        {% for c in categories %}
          <option value="{{ c.category_id }}"
            {% if selected_category == c.category_id|stringformat:"s" %}selected{% endif %}>
            {{ c.category_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label>T√°c gi·∫£</label>
      <select name="author">
        <option value="">T·∫•t c·∫£</option>
        {% for a in authors %}
          <option value="{{ a.author_id }}"
            {% if selected_author == a.author_id|stringformat:"s" %}selected{% endif %}>
            {{ a.author_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label>Nh√† xu·∫•t b·∫£n</label>
      <select name="publisher">
        <option value="">T·∫•t c·∫£</option>
        {% for p in publishers %}
          <option value="{{ p.publish_id }}"
            {% if selected_publisher == p.publish_id|stringformat:"s" %}selected{% endif %}>
            {{ p.publish_name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-group">
      <label>Ng√†y nh·∫≠p</label>
      <input type="date" name="date_add" value="{{ selected_date }}">
    </div>

    <div class="filter-group">
      <label>Tr·∫°ng th√°i</label>
      <select name="status">
        <option value="" {% if not selected_status %}selected{% endif %}>T·∫•t c·∫£</option>
        <option value="available" {% if selected_status == "available" %}selected{% endif %}>C√≤n tr·ªëng</option>
        <option value="borrowed" {% if selected_status == "borrowed" %}selected{% endif %}>ƒê√£ ƒë∆∞·ª£c m∆∞·ª£n</option>
      </select>
    </div>

    <!-- N√∫t √°p d·ª•ng l·ªçc -->
    <div class="filter-actions">
      <button type="submit" class="btn-apply">√Åp d·ª•ng</button>
      <!-- t√πy ch·ªçn: n√∫t x√≥a l·ªçc -->
      <a href="{% url 'user_books_author' %}" class="btn-reset">L√†m m·ªõi</a>
    </div>
  </form>
  {% if recommended_books %}
<div class="recommend-section">
    <h2 class="section-title">üìö G·ª£i √Ω d√†nh cho b·∫°n</h2>

    <div class="book-display recommended">
        {% for b in recommended_books %}
        <div class="book-card"
             data-id="{{ b.pk }}"
             data-available="{{ b.available }}"
             data-title="{{ b.book_name }}"
             data-author="{{ b.author.author_name }}"
             data-categories="{% for c in b.categories.all %}{{ c.category_name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
             data-publisher="{{ b.publisher.publish_name }}"
             data-year="{{ b.publishYear|default:'-' }}"
             data-date="{{ b.dateAdd }}"
             data-status="{% if b.available > 0 %}C√≤n tr·ªëng ({{ b.available }}){% else %}ƒê√£ ƒë∆∞·ª£c m∆∞·ª£n{% endif %}"
             data-description="{{ b.description|default_if_none:''|escape }}"
             data-image="{% if b.image %}{{ b.image.url }}{% endif %}">
            
            <div class="book-img">
                {% if b.image %}
                    <img src="{{ b.image.url }}" alt="{{ b.book_name }}">
                {% else %}
                    <div class="img-placeholder">Kh√¥ng c√≥ ·∫£nh</div>
                {% endif %}
            </div>

            <div class="book-info">
                <h3 class="book-title">{{ b.book_name }}</h3>
                <p class="book-author">T√°c gi·∫£: {{ b.author.author_name }}</p>
                <p class="book-publisher">NXB: {{ b.publisher.publish_name }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

    <!-- BOTTOM: BOOK DISPLAY (HI·ªÇN TH·ªä TO√ÄN B·ªò S√ÅCH) -->
    <div class="bottom-section">
        <h2 class="section-title">Danh s√°ch s√°ch</h2>

        <div class="book-display">
  {% if books %}
    {% for b in books %}
      <div class="book-card"
           data-id="{{ b.pk }}"
           data-available="{{ b.available }}" data-title="{{ b.book_name }}"
           data-author="{{ b.author.author_name }}"
           data-categories="{% for c in b.categories.all %}{{ c.category_name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
           data-publisher="{{ b.publisher.publish_name }}"
           data-year="{{ b.publishYear|default:"-" }}"
           data-date="{{ b.dateAdd }}"
           data-status="{% if b.available > 0 %}C√≤n tr·ªëng ({{ b.available }}){% else %}ƒê√£ ƒë∆∞·ª£c m∆∞·ª£n{% endif %}"
           data-description="{{ b.description|default_if_none:''|escape }}"
           data-image="{% if b.image %}{{ b.image.url }}{% endif %}">
        <div class="book-img">
          {% if b.image %}
            <img src="{{ b.image.url }}" alt="{{ b.book_name }}">
          {% else %}
            <div class="img-placeholder">Kh√¥ng c√≥ ·∫£nh</div>
          {% endif %}
        </div>
        <div class="book-info">
          <h3 class="book-title">{{ b.book_name }}</h3>
          <p class="book-author">T√°c gi·∫£: {{ b.author.author_name }}</p>
          <p class="book-categories">
            Th·ªÉ lo·∫°i:
            {% with cats=b.categories.all %}
              {% if cats %}
                {% for c in cats %}
                  {{ c.category_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              {% else %}-{% endif %}
            {% endwith %}
          </p>
          <p class="book-publisher">NXB: {{ b.publisher.publish_name }}</p>
          <p class="book-year">NƒÉm XB: {{ b.publishYear|default:"-" }}</p>
          <p class="book-date">Ng√†y nh·∫≠p: {{ b.dateAdd }}</p>
          {% if b.available > 0 %}
            <p class="book-status available">S·ªë l∆∞·ª£ng: {{ b.available }} cu·ªën</p>
          {% else %}
            <p class="book-status borrowed">S·ªë l∆∞·ª£ng: ƒë√£ h·∫øt s√°ch</p>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>Kh√¥ng c√≥ s√°ch n√†o trong c∆° s·ªü d·ªØ li·ªáu.</p>
  {% endif %}
</div>
    </div>

</div>
<!-- Modal chi ti·∫øt s√°ch -->
<div class="book-modal-backdrop" id="bookModalBackdrop" aria-hidden="true">
  <div class="book-modal" role="dialog" aria-modal="true" aria-labelledby="bookModalTitle">
    <button class="modal-close" id="bookModalClose" aria-label="ƒê√≥ng">√ó</button>

    <h3 class="modal-title" id="bookModalTitle">Th√¥ng tin s√°ch</h3>

    <div class="modal-body">
      <div class="modal-left">
        <div class="modal-img-wrap">
          <img id="modalBookImg" alt="·∫¢nh s√°ch">
        </div>
      </div>
      <div class="modal-right">
        <div class="modal-line modal-name" id="modalBookName"></div>
        <div class="modal-line">T√°c gi·∫£: <span id="modalBookAuthor"></span></div>
        <div class="modal-line">Th·ªÉ lo·∫°i: <span id="modalBookCategories"></span></div>
        <div class="modal-line">NXB: <span id="modalBookPublisher"></span></div>
        <div class="modal-line">NƒÉm XB: <span id="modalBookYear"></span></div>
        <div class="modal-line">Ng√†y nh·∫≠p: <span id="modalBookDate"></span></div>
        <div class="modal-line">Tr·∫°ng th√°i: <span id="modalBookStatus"></span></div>
      </div>
    </div>

    <div class="modal-desc">
      <label>M√¥ t·∫£ s√°ch</label>
      <div class="modal-desc-content" id="modalBookDesc"></div>
    </div>

    <div class="modal-actions">
      <button class="btn-confirm" id="modalConfirmBorrow">ƒê·∫∑t tr∆∞·ªõc s√°ch</button>
    </div>
  </div>
</div>

<script>
  (function() {
    const backdrop = document.getElementById('bookModalBackdrop');
    const closeBtn = document.getElementById('bookModalClose');

    const imgEl = document.getElementById('modalBookImg');
    const nameEl = document.getElementById('modalBookName');
    const authorEl = document.getElementById('modalBookAuthor');
    const catsEl = document.getElementById('modalBookCategories');
    const pubEl = document.getElementById('modalBookPublisher');
    const yearEl = document.getElementById('modalBookYear');
    const dateEl = document.getElementById('modalBookDate');
    const statusEl = document.getElementById('modalBookStatus');
    const descEl = document.getElementById('modalBookDesc');

    let currentBookId = null; // L∆ØU BOOK ID ƒêANG XEM
    let currentBookAvailable = 0; // 1. TH√äM BI·∫æN N√ÄY ƒê·ªÇ L∆ØU S·ªê L∆Ø·ª¢NG

    function openModal(data) {
      nameEl.textContent = data.title || '';
      authorEl.textContent = data.author || '';
      catsEl.textContent = data.categories || '';
      pubEl.textContent = data.publisher || '';
      yearEl.textContent = data.year || '-';
      dateEl.textContent = data.date || '';
      statusEl.textContent = data.status || '';
      descEl.textContent = data.description || '‚Äî';

      if (data.image) {
        imgEl.src = data.image;
        imgEl.style.display = 'block';
      } else {
        imgEl.removeAttribute('src');
        imgEl.style.display = 'none';
      }

      backdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      backdrop.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      currentBookId = null; // reset
    }

    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', function(e) {
      if (e.target === backdrop) closeModal();
    });

    // G·∫Øn click cho t·ª´ng card
    document.querySelectorAll('.book-card').forEach(card => {
      card.addEventListener('click', () => {
        const data = {
          title: card.dataset.title,
          author: card.dataset.author,
          categories: card.dataset.categories,
          publisher: card.dataset.publisher,
          year: card.dataset.year,
          date: card.dataset.date,
          status: card.dataset.status,
          description: card.dataset.description,
          image: card.dataset.image
        };
        currentBookId = card.dataset.id; // L·∫§Y ID
        currentBookAvailable = parseInt(card.dataset.available); // 2. L·∫§Y S·ªê L∆Ø·ª¢NG T·ª™ DATA-ATTRIBUTE
        openModal(data);
      });
    });

    // Submit form POST ƒë·∫øn request_borrow
    document.getElementById('modalConfirmBorrow').addEventListener('click', () => {
      if (!currentBookId) return;

      const form = document.getElementById('borrowRequestForm');
      form.action = `/borrow/reserve/${currentBookId}/`;
      form.submit();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && backdrop.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    });
  })();
</script>
<form id="borrowRequestForm" method="post" style="display:none;">
  {% csrf_token %}
</form>
{% if messages %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        {% for message in messages %}
            // X√°c ƒë·ªãnh lo·∫°i icon d·ª±a tr√™n tags c·ªßa message (error/success/warning)
            var type = "{{ message.tags }}";
            var icon = "info";
            var title = "Th√¥ng b√°o";

            if (type.includes("error")) {
                icon = "error";
                title = "Kh√¥ng th·ªÉ m∆∞·ª£n!";
            } else if (type.includes("success")) {
                icon = "success";
                title = "Th√†nh c√¥ng";
            } else if (type.includes("warning")) {
                icon = "warning";
                title = "C·∫£nh b√°o";
            }

            // Hi·ªÉn th·ªã Popup
            Swal.fire({
                icon: icon,
                title: title,
                text: "{{ message|escapejs }}", // N·ªôi dung l·ªói t·ª´ views/signals s·∫Ω hi·ªán ·ªü ƒë√¢y
                confirmButtonText: 'ƒê√£ hi·ªÉu',
                confirmButtonColor: '#3085d6'
            });
        {% endfor %}
    });
</script>
{% endif %}
</body>
</html>